**timer module 是什么？有什么作用？**

timer module 是一个软件模块。

该软件模块管理了芯片内部链路控制器硬件的各个定时器，关于这些定时器的详细介绍，可在射频控制器参考手册里找到。

timer module 根据抽象程度的不同分为了两个层次 （HAL, LL）。可为设备的唤醒、用户超时触发和预配置的射频事务触发关联一个事件；举个例子，用户可编程一个事件，实现：

- 定时唤醒休眠的系统
- 或产生一个超时事件
- 或为蓝牙事件提供时间依据



timer module 的源码实现包含以下文件：

> bluenrg_lp_hal_vtimer.h
>
> bluenrg_lp_hal_vtimer.c
>
> bluenrg_lp_ll_timer.h
>
> bluenrg_lp_ll_timer.c

ll 层比较靠近硬件，主要实现了对硬件定时器的编程、低频时钟的管理和定时时间的转换（将 hal 的时间值转化为硬件定时器寄存器的值）

hal 层是对 ll 层的进一步抽象，封装了硬件的细节。主要实现了虚拟定时器序列，回调管理，校准调度，射频事件调度等。



虚定时器

链路控制器计数器。链路控制器中有一个计数器，定时器模块可利用该硬件计数器来虚拟出多个软件定时器。

时间基准。虚拟定时器的有一个特定的单位，称为系统时间单位（STU system time unit）。一个 STU = 625/256 us。在对真正的计数器进行编程之前，需要将用 STUs 表示的时间转换到硬件计时器计数单元中。

校准间隔。是一个参数，可以在初始化阶段设置，以决定该设备需要多长时间对内部振荡器的频率进行测量；当计数器使用的时钟源是外部晶振时，则不需要该参数。



射频计数器

BLUENRG-LP 提供了另外一个定时器专门用于触发射频事务（transaction）。该事务可以是一次射频发送、或射频接收。



休眠管理

定时器模块可避免系统在以下条件下进入休眠：

- 虚拟定时器已经触发但回调函数还在执行
- 低频时钟检测流程正在进行
- 下一个射频事务已经很接近要触发了
- The device is in a back-to-back communication  

